<!DOCTYPE html>
  <html>
    <head>
      <title>GCRN代码解读</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/beta/.atom/packages/markdown-preview-enhanced/node_modules/@shd101wyy/mume/dependencies/katex/katex.min.css">
      
      
      
      
      
      

      <style> 
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
 
      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview   ">
      <h1 class="mume-header" id="gcrn&#x4EE3;&#x7801;&#x89E3;&#x8BFB;">GCRN代码解读</h1>

<ul>
<li>论文及源代码：<a href="https://github.com/youngjoo-epfl/gconvRNN">点击这里</a></li>
</ul>
<p>若有错误，欢迎指正。</p>
<p>GCN，是基于Spectral Graph Theory所研究出来的一种方法，它主要的好处是利用了SGT里面一些已有的结论和方法，来得到图的性质。GCRN是一个将GCN和RNN结合起来使用的模型，能处理具有空间和时序的数据。</p>
<p>源代码的目录结构：</p>
<pre class="language-">gconvRNN
  - datasets
    - ptb.char.test.txt
    - ptb.char.train.txt
    - ptb.char.valid.txt
  - gcrn_main.py  # &#x6574;&#x4E2A;&#x7A0B;&#x5E8F;&#x7684;&#x5165;&#x53E3;
  - config.py  # &#x7528;&#x4E8E;&#x914D;&#x7F6E;&#x8D85;&#x53C2;&#x6570;
  - graph.py  # &#x4E0E;&#x56FE;&#x76F8;&#x5173;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x6BD4;&#x5982;laplacian&#x77E9;&#x9635;
  - model.py  # &#x6A21;&#x578B;&#x7684;&#x5B9A;&#x4E49;
  - trainer.py  # &#x5B9A;&#x4E49;&#x4E86;&#x8BAD;&#x7EC3;&#x8FC7;&#x7A0B;
  - utils.py  # &#x6570;&#x636E;&#x9884;&#x5904;&#x7406;&#x3001;&#x5DE5;&#x5177;
</pre>
<p>在源码中，GCRN用于预测单词字符序列</p>
<p>本文从三个方面讲解GCRN源码的处理思路</p>
<ul>
<li>数据预处理</li>
<li>GCRN实现思路</li>
<li>开始训练</li>
<li>代码附录</li>
</ul>
<h3 class="mume-header" id="&#x6570;&#x636E;&#x9884;&#x5904;&#x7406;">数据预处理：</h3>

<p><em>train\valid\test 数据集的格式都是一样的：</em></p>
<blockquote>
<p>a e r _ b a n k n o t e _ b e r l i t z _ c a l l o w a y _ c e n t r u s t _ c l u e t t _ f r o m s t e i n _ g i t a n o _ g u t e r m a n _ h y d r o - q u e b e c _ i p o _ k i a _ m e m o t e c _ m l x _ n a h b _ p u n t s _ r a k e _ r e g a t t a _ r u b e n s _ s i m _ s n a c k - f o o d _ s s a n g y o n g _ s w a p o _ w a c h t e r <br><br>
p i e r r e _ &lt; u n k &gt; _ N _ y e a r s _ o l d _ w i l l _ j o i n _ t h e _ b o a r d _ a s _ a _ n o n e x e c u t i v e _ d i r e c t o r _ n o v . _ N <br><br>
m r . _ &lt; u n k &gt; _ i s _ c h a i r m a n _ o f _ &lt; u n k &gt; _ n . v . _ t h e _ d u t c h _ p u b l i s h i n g _ g r o u p</p>
</blockquote>
<ul>
<li><code>UNK</code> - &quot;unknown token&quot; - is used to replace the rare words that did not fit in your vocabulary. So your sentence <code>My name is guotong1998</code> will be translated into <code>My name is _unk_</code></li>
</ul>
<p><strong>1. 将句子按字典映射成数字序列</strong></p>
<pre class="language-">for every sentences:
  &#x5728;&#x53E5;&#x5B50;&#x540E;&#x9762;&#x52A0;&#x201C;|&#x201D;&#xFF08;&#x4EBA;&#x4E3A;&#x5730;&#x6DFB;&#x52A0;&#x53E5;&#x5B50;&#x7684;&#x7ED3;&#x675F;&#x6807;&#x8BC6;&#x7B26;&#xFF09;
  &#x5C06;&#x53E5;&#x5B50;&#x91CC;&#x9762;&#x7684;*&#x6BCF;&#x4E2A;&#x5B57;&#x7B26;*&#x6620;&#x5C04;&#x6210;&#x8BE5;&#x5B57;&#x7B26;&#x5728;&#x5B57;&#x5178;&#x4E2D;*&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x5B57;*
</pre>
<p>例如：</p>
<p>p i e r r e _ &lt; u n k &gt; _ N _ y e a r s _ o l d _ w i l l _ j o i n _ t h e _ b o a r d _ a s _ a _ n o n e x e c u t i v e _ d i r e c t o r _ n o v . _ N |</p>
<p>[24, 10, 1, 2, 2, 1, 3, 27, 15, 5, 6, 28, 3, 29, 3, 14, 1, 0, 2, 16, 3, 7, 9, 21, 3, 13, 10, 9, 9, 3, 30, 7, 10, 5, 3, 8, 20, 1, 3, 4, 7, 0, 2, 21, 3, 0, 16, 3, 0, 3, 5, 7, 5, 1, 25, 1, 12, 15, 8, 10, 31, 1, 3, 21, 10, 2, 1, 12, 8, 7, 2, 3, 5, 7, 31, 32, 3, 29, 26]</p>
<p><strong>2. 构造邻接矩阵</strong></p>
<p><img src="./img/adj.png" alt=""></p>
<p>得到邻接矩阵的值：</p>
<p><img src="./img/adj_value.png" alt=""></p>
<h3 class="mume-header" id="gcrn&#x5B9E;&#x73B0;&#x601D;&#x8DEF;">GCRN实现思路：</h3>

<p>GCRN = GCN + RNN。</p>
<p><em>公式</em>：</p>
<p><img src="./img/gconv.png" alt=""></p>
<p><img src="./img/lstm_func.png" alt=""></p>
<p><strong>但是</strong> 代码中的实现方式稍有不同</p>
<p><strong>GCN</strong> ：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mo>=</mo><mi>a</mi><mi>d</mi><mi>j</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>d</mi><mi>j</mi><mi mathvariant="normal">.</mi><mi>m</mi><mi>a</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">L = adj/adj.max</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base"><span class="mord mathit">L</span><span class="mrel">=</span><span class="mord mathit">a</span><span class="mord mathit">d</span><span class="mord mathit" style="margin-right:0.05724em;">j</span><span class="mord mathrm">/</span><span class="mord mathit">a</span><span class="mord mathit">d</span><span class="mord mathit" style="margin-right:0.05724em;">j</span><span class="mord mathrm">.</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit">x</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>a</mi><mi>p</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>i</mi><mi>a</mi><mi>n</mi><mo>=</mo><mfrac><mrow><mn>2</mn><mi>L</mi></mrow><mrow><mi>l</mi><mi>m</mi><mi>a</mi><mi>x</mi></mrow></mfrac><mo>−</mo><mi>I</mi></mrow><annotation encoding="application/x-tex">Laplacian = \frac{2L}{lmax} - I</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.36033em;"></span><span class="strut bottom" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="base"><span class="mord mathit">L</span><span class="mord mathit">a</span><span class="mord mathit">p</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">a</span><span class="mord mathit">c</span><span class="mord mathit">i</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mrel">=</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathrm">2</span><span class="mord mathit">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mbin">−</span><span class="mord mathit" style="margin-right:0.07847em;">I</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mi>k</mi></msub><mo>(</mo><mi>x</mi><mo>)</mo><mo>=</mo><mn>2</mn><mi>L</mi><msub><mi>T</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>(</mo><mi>x</mi><mo>)</mo><mo>−</mo><msub><mi>T</mi><mrow><mi>k</mi><mo>−</mo><mn>2</mn></mrow></msub><mo>(</mo><mi>x</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">T_k(x) = 2LT_{k-1}(x)-T_{k-2}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mrel">=</span><span class="mord mathrm">2</span><span class="mord mathit">L</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mathrm mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"></span></span></span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mbin">−</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mathrm mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"></span></span></span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span></span></p>
<p>每次得到的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mi>k</mi></msub><mo>(</mo><mi>x</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">T_k(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span> 都与x做concat，最后得到的x与W相乘</p>
<p><strong>LSTM</strong> ：</p>
<p><img src="./img/gcn_lstm.png" alt=""></p>
<h3 class="mume-header" id="&#x5F00;&#x59CB;&#x8BAD;&#x7EC3;">开始训练</h3>

<p>数据预处理 -&gt; model定义 -&gt; train</p>
<p><img src="./img/dataflow.png" alt=""></p>
<p>输出<code>ouput</code>的shape为(batch_size, num_node, num_unit) —— (20, 50, 50)。由于设置了有50个LSTM units，所以这里需要使所有units的输出做线性变换，使其变为一个值：</p>
<ul>
<li><code>prediction = output * W -b</code>，这里的<code>prediction</code>的shape为(20, 50, 1)</li>
</ul>
<p>那么，所有时刻的输出的shape为(50, 20, 50, 1)</p>
<h3 class="mume-header" id="&#x4EE3;&#x7801;">代码</h3>

<p><strong>GCN实现方法</strong></p>
<pre class="language-python"><span class="token keyword">def</span> <span class="token function">cheby_conv</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> L<span class="token punctuation">,</span> lmax<span class="token punctuation">,</span> feat_out<span class="token punctuation">,</span> K<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    x : [batch_size, N_node, feat_in] - input of each time step
    nSample : number of samples = batch_size
    nNode : number of node in graph
    feat_in : number of input feature
    feat_out : number of output feature
    L : laplacian
    lmax : ?
    K : size of kernel(number of cheby coefficients)
    W : cheby_conv weight [K * feat_in, feat_out]
    '''</span>
    nSample<span class="token punctuation">,</span> nNode<span class="token punctuation">,</span> feat_in <span class="token operator">=</span> x<span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span>
    nSample<span class="token punctuation">,</span> nNode<span class="token punctuation">,</span> feat_in <span class="token operator">=</span> int<span class="token punctuation">(</span>nSample<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>nNode<span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>feat_in<span class="token punctuation">)</span>
    L <span class="token operator">=</span> graph<span class="token punctuation">.</span>rescale_L<span class="token punctuation">(</span>L<span class="token punctuation">,</span> lmax<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#What is this operation?? --> rescale Laplacian</span>
    L <span class="token operator">=</span> L<span class="token punctuation">.</span>tocoo<span class="token punctuation">(</span><span class="token punctuation">)</span>

    indices <span class="token operator">=</span> np<span class="token punctuation">.</span>column_stack<span class="token punctuation">(</span><span class="token punctuation">(</span>L<span class="token punctuation">.</span>row<span class="token punctuation">,</span> L<span class="token punctuation">.</span>col<span class="token punctuation">)</span><span class="token punctuation">)</span>
    L <span class="token operator">=</span> tf<span class="token punctuation">.</span>SparseTensor<span class="token punctuation">(</span>indices<span class="token punctuation">,</span> L<span class="token punctuation">.</span>data<span class="token punctuation">,</span> L<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    L <span class="token operator">=</span> tf<span class="token punctuation">.</span>sparse_reorder<span class="token punctuation">(</span>L<span class="token punctuation">)</span>

    x0 <span class="token operator">=</span> tf<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>x<span class="token punctuation">,</span> perm<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#change it to [nNode, feat_in, nSample]</span>
    x0 <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>x0<span class="token punctuation">,</span> <span class="token punctuation">[</span>nNode<span class="token punctuation">,</span> feat_in<span class="token operator">*</span>nSample<span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>x0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># make it [1, nNode, feat_in*nSample]</span>

    <span class="token keyword">def</span> <span class="token function">concat</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> x_<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_ <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>x_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> x_<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> K <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
        x1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>sparse_tensor_dense_matmul<span class="token punctuation">(</span>L<span class="token punctuation">,</span> x0<span class="token punctuation">)</span>
        x <span class="token operator">=</span> concat<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x1<span class="token punctuation">)</span>

    <span class="token keyword">for</span> k <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x2 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> tf<span class="token punctuation">.</span>sparse_tensor_dense_matmul<span class="token punctuation">(</span>L<span class="token punctuation">,</span> x1<span class="token punctuation">)</span> <span class="token operator">-</span> x0
        x <span class="token operator">=</span> concat<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>
        x0<span class="token punctuation">,</span> x1 <span class="token operator">=</span> x1<span class="token punctuation">,</span> x2

    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token punctuation">,</span> nNode<span class="token punctuation">,</span> feat_in<span class="token punctuation">,</span> nSample<span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>x<span class="token punctuation">,</span> perm<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">[</span>nSample<span class="token operator">*</span>nNode<span class="token punctuation">,</span> feat_in<span class="token operator">*</span>K<span class="token punctuation">]</span><span class="token punctuation">)</span>

    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>x<span class="token punctuation">,</span> W<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#No Bias term?? -> Yes</span>
    out <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">[</span>nSample<span class="token punctuation">,</span> nNode<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out
</pre>
<p><strong>LSTM实现方法</strong></p>
<pre class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> state<span class="token punctuation">,</span> scope<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span>scope <span class="token operator">or</span> type<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state_is_tuple<span class="token punctuation">:</span>
            c<span class="token punctuation">,</span> h <span class="token operator">=</span> state
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            c<span class="token punctuation">,</span> h <span class="token operator">=</span> tf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>value<span class="token operator">=</span>state<span class="token punctuation">,</span> num_or_size_splits<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        laplacian <span class="token operator">=</span> self<span class="token punctuation">.</span>_laplacian
        lmax <span class="token operator">=</span> self<span class="token punctuation">.</span>_lmax
        K <span class="token operator">=</span> self<span class="token punctuation">.</span>_K
        feat_in <span class="token operator">=</span> self<span class="token punctuation">.</span>_feat_in

        <span class="token comment" spellcheck="true">#The inputs : [batch_size, nNode, feat_in, nTime?] size tensor</span>
        <span class="token keyword">if</span> feat_in <span class="token keyword">is</span> None<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true">#Take out the shape of input</span>
            batch_size<span class="token punctuation">,</span> nNode<span class="token punctuation">,</span> feat_in <span class="token operator">=</span> inputs<span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hey!"</span><span class="token punctuation">)</span>

        feat_out <span class="token operator">=</span> self<span class="token punctuation">.</span>_num_units

        <span class="token keyword">if</span> K <span class="token keyword">is</span> None<span class="token punctuation">:</span>
            K <span class="token operator">=</span> <span class="token number">2</span>

        scope <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable_scope<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>variable_scope<span class="token punctuation">(</span>scope<span class="token punctuation">)</span> <span class="token keyword">as</span> scope<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token comment" spellcheck="true">#Need four diff Wconv weight + for Hidden weight</span>
                Wzxt <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wzxt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_in<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Wixt <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wixt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_in<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Wfxt <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wfxt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_in<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Woxt <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Woxt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_in<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                Wzht <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wzht"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_out<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Wiht <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wiht"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_out<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Wfht <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wfht"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_out<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Woht <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Woht"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_out<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
                scope<span class="token punctuation">.</span>reuse_variables<span class="token punctuation">(</span><span class="token punctuation">)</span>
                Wzxt <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wzxt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_in<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Wixt <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wixt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_in<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Wfxt <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wfxt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_in<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Woxt <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Woxt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_in<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                Wzht <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wzht"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_out<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Wiht <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wiht"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_out<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Wfht <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Wfht"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_out<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                Woht <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"Woht"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>K<span class="token operator">*</span>feat_out<span class="token punctuation">,</span> feat_out<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
                                       initializer<span class="token operator">=</span>tf<span class="token punctuation">.</span>random_uniform_initializer<span class="token punctuation">(</span>minval<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


            bzt <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"bzt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>feat_out<span class="token punctuation">]</span><span class="token punctuation">)</span>
            bit <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"bit"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>feat_out<span class="token punctuation">]</span><span class="token punctuation">)</span>
            bft <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"bft"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>feat_out<span class="token punctuation">]</span><span class="token punctuation">)</span>
            bot <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_variable<span class="token punctuation">(</span><span class="token string">"bot"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>feat_out<span class="token punctuation">]</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true"># gconv Calculation</span>
            zxt <span class="token operator">=</span> cheby_conv<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> laplacian<span class="token punctuation">,</span> lmax<span class="token punctuation">,</span> feat_out<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Wzxt<span class="token punctuation">)</span>
            zht <span class="token operator">=</span> cheby_conv<span class="token punctuation">(</span>h<span class="token punctuation">,</span> laplacian<span class="token punctuation">,</span> lmax<span class="token punctuation">,</span> feat_out<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Wzht<span class="token punctuation">)</span>
            zt  <span class="token operator">=</span> zxt <span class="token operator">+</span> zht <span class="token operator">+</span> bzt
            zt  <span class="token operator">=</span> tf<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>zt<span class="token punctuation">)</span>

            ixt <span class="token operator">=</span> cheby_conv<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> laplacian<span class="token punctuation">,</span> lmax<span class="token punctuation">,</span> feat_out<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Wixt<span class="token punctuation">)</span>
            iht <span class="token operator">=</span> cheby_conv<span class="token punctuation">(</span>h<span class="token punctuation">,</span> laplacian<span class="token punctuation">,</span> lmax<span class="token punctuation">,</span> feat_out<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Wiht<span class="token punctuation">)</span>
            it  <span class="token operator">=</span> ixt <span class="token operator">+</span> iht <span class="token operator">+</span> bit
            it  <span class="token operator">=</span> tf<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>it<span class="token punctuation">)</span>

            fxt <span class="token operator">=</span> cheby_conv<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> laplacian<span class="token punctuation">,</span> lmax<span class="token punctuation">,</span> feat_out<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Wfxt<span class="token punctuation">)</span>
            fht <span class="token operator">=</span> cheby_conv<span class="token punctuation">(</span>h<span class="token punctuation">,</span> laplacian<span class="token punctuation">,</span> lmax<span class="token punctuation">,</span> feat_out<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Wfht<span class="token punctuation">)</span>
            ft  <span class="token operator">=</span> fxt <span class="token operator">+</span> fht <span class="token operator">+</span> bft
            ft  <span class="token operator">=</span> tf<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>ft<span class="token punctuation">)</span>

            oxt <span class="token operator">=</span> cheby_conv<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> laplacian<span class="token punctuation">,</span> lmax<span class="token punctuation">,</span> feat_out<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Woxt<span class="token punctuation">)</span>
            oht <span class="token operator">=</span> cheby_conv<span class="token punctuation">(</span>h<span class="token punctuation">,</span> laplacian<span class="token punctuation">,</span> lmax<span class="token punctuation">,</span> feat_out<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Woht<span class="token punctuation">)</span>
            ot  <span class="token operator">=</span> oxt <span class="token operator">+</span> oht <span class="token operator">+</span> bot
            ot  <span class="token operator">=</span> tf<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>ot<span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true"># c</span>
            new_c <span class="token operator">=</span> ft<span class="token operator">*</span>c <span class="token operator">+</span> it<span class="token operator">*</span>zt

            <span class="token comment" spellcheck="true"># h</span>
            new_h <span class="token operator">=</span> ot<span class="token operator">*</span>tf<span class="token punctuation">.</span>tanh<span class="token punctuation">(</span>new_c<span class="token punctuation">)</span>

            <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state_is_tuple<span class="token punctuation">:</span>
                new_state <span class="token operator">=</span> LSTMStateTuple<span class="token punctuation">(</span>new_c<span class="token punctuation">,</span> new_h<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                new_state <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>new_c<span class="token punctuation">,</span> new_h<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> new_h<span class="token punctuation">,</span> new_state
</pre>
<h5 class="mume-header" id="&#x5176;&#x4ED6;&#x53D8;&#x91CF;">其他变量</h5>

<table>
<thead>
<tr>
<th>变量</th>
<th>shape</th>
<th>meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>rnn_input</td>
<td>(20, 50, 1, 50)</td>
<td>(batch_size, num_node, feat_in, num_time_steps)</td>
</tr>
<tr>
<td>rnn_input_seq</td>
<td>(20, 50, 1) * 50</td>
<td>(batch_size, num_node, feat_in) * num_time_steps</td>
</tr>
<tr>
<td>rnn_output</td>
<td>(20, 50)</td>
<td>(batch_size, num_time_steps)</td>
</tr>
<tr>
<td>rnn_output_seq</td>
<td>(20) * 50</td>
<td>(batch_size) * num_time_steps</td>
</tr>
<tr>
<td>num_hidden</td>
<td>50</td>
<td>隐藏层单元</td>
</tr>
<tr>
<td>x_batches</td>
<td>(5017, 20, 50)</td>
<td>[-1, batch_size, seq_length]</td>
</tr>
<tr>
<td>y_batches</td>
<td>(5017, 20, 50)</td>
<td>[-1, batch_size, seq_length]</td>
</tr>
<tr>
<td>outputs</td>
<td>(50, 20, 50, 50)</td>
<td>(50个时刻50个输出, batch_size, num_node, num_unit)</td>
</tr>
<tr>
<td>output</td>
<td>(20, 50, 50)</td>
<td>outputs的单个时刻输出(batch_size, num_node, num_unit)</td>
</tr>
</tbody>
</table>
<h3 class="mume-header" id="laplacian-matrix">Laplacian matrix</h3>

<p><img src="./img/laplacian_example.png" alt=""></p>
<p><strong>Properties</strong></p>
<p>对一个无向图<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">G</span></span></span></span>和他的laplacian matrix <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">L</span></span></span></span>，有特征值<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>λ</mi><mn>0</mn></msub><mo>≤</mo><msub><mi>λ</mi><mn>1</mn></msub><mo>≤</mo><msub><mi>λ</mi><mn>2</mn></msub><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">\lambda_0 \leq \lambda_1 \leq \lambda_2 ...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="base"><span class="mord"><span class="mord mathit">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mrel">≤</span><span class="mord"><span class="mord mathit">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mrel">≤</span><span class="mord"><span class="mord mathit">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord mathrm">.</span><span class="mord mathrm">.</span><span class="mord mathrm">.</span></span></span></span>：</p>
<ul>
<li>L是对称的</li>
<li>L是半正定的（即所有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>λ</mi><mi>i</mi></msub><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\lambda_i &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="base"><span class="mord"><span class="mord mathit">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mrel">&gt;</span><span class="mord mathrm">0</span></span></span></span>），这可以在关联矩阵部分验证，也同样可以从Laplacian是对称并且对角占优(diagonally dominant)得出</li>
<li>L是M-matrix（它的非对角线上的项是负的，但它的特征值的实部为负）</li>
<li>行或列相加结果为0</li>
<li>L的最小非零特征值称为谱间隙（spectral gap）</li>
<li>图中连通分量的个数是拉普拉斯算子的零空间维数和0特征值的代数多重性</li>
<li>拉普拉斯矩阵是奇异的</li>
</ul>
<h3 class="mume-header" id="&#x95EE;&#x9898;">问题</h3>

<ol>
<li>代码实现里面的公式跟论文是否真的不一样</li>
<li>x2 = 2 * tf.sparse_tensor_dense_matmul(L, x1) - x0 起到一个什么作用</li>
</ol>

      </div>
      <div class="md-sidebar-toc"><ul>
<li><a href="#gcrn%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB">GCRN代码解读</a><br>
* <a href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86">数据预处理：</a><br>
* <a href="#gcrn%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">GCRN实现思路：</a><br>
* <a href="#%E5%BC%80%E5%A7%8B%E8%AE%AD%E7%BB%83">开始训练</a><br>
* <a href="#%E4%BB%A3%E7%A0%81">代码</a><br>
* <a href="#%E5%85%B6%E4%BB%96%E5%8F%98%E9%87%8F">其他变量</a><br>
* <a href="#laplacian-matrix">Laplacian matrix</a><br>
* <a href="#%E9%97%AE%E9%A2%98">问题</a></li>
</ul>
</div>
      <a id="sidebar-toc-btn">≡</a>
    </body>
    
    
    
    <script>
(function bindTaskListEvent() {
  var taskListItemCheckboxes = document.body.getElementsByClassName('task-list-item-checkbox')
  for (var i = 0; i < taskListItemCheckboxes.length; i++) {
    var checkbox = taskListItemCheckboxes[i]
    var li = checkbox.parentElement
    if (li.tagName !== 'LI') li = li.parentElement
    if (li.tagName === 'LI') {
      li.classList.add('task-list-item')
    }
  }
}())    
</script>
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  </html>